/dts-v1/;
#include <nxp/nxp_lpc55S16_ns.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/gpio/gpio.h>
#include <physical_layouts.dtsi>

/ {
    model = "HyperX Alloy Rise 75";
    compatible = "hyperx,alloy-rise-75", "nxp,lpc55xxx", "nxp,lpc";

    chosen {
        zephyr,sram = &sram0;
        zephyr,flash = &flash0;
        zephyr,code-partition = &slot0_partition;
        zephyr,udc0 = &usbhs;
        zmk,physical-layout = &physical_layout0;
        zmk,kscan = &kscan0;
    };

    left_encoder: encoder_left {
        compatible = "alps,ec11";
        a-gpios = <&gpio1 9 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>; 
        b-gpios = <&gpio1 7 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>; 
        steps = <80>;
        status = "okay";
    };

    sensors: sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&left_encoder>;
        triggers-per-rotation = <20>;
    };

    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <19>;
        rows = <6>;
        map = <
            RC(0,0) RC(0,9) RC(0,17) RC(0,14) RC(0,10) RC(0,11) RC(0,12) RC(0,15) RC(0,2) RC(0,3) RC(0,1) RC(0,8) RC(0,7) RC(0,5) RC(0,16)
            RC(1,0) RC(1,4) RC(1,9) RC(1,17) RC(1,14) RC(1,10) RC(1,11) RC(1,12) RC(1,15) RC(1,2) RC(1,3) RC(1,1) RC(1,8) RC(1,13) RC(1,6) RC(1,18)
            RC(2,0) RC(2,4) RC(2,9) RC(2,17) RC(2,14) RC(2,10) RC(2,11) RC(2,12) RC(2,15) RC(2,2) RC(2,3) RC(2,1) RC(2,8) RC(2,7) RC(2,6)
            RC(3,0) RC(3,4) RC(3,9) RC(3,17) RC(3,14) RC(3,10) RC(3,11) RC(3,12) RC(3,15) RC(3,2) RC(3,3) RC(3,1) RC(3,7)
            RC(4,0) RC(4,9) RC(4,17) RC(4,14) RC(4,10) RC(4,11) RC(4,12) RC(4,15) RC(4,2) RC(4,3) RC(4,1) RC(4,7) RC(4,5)
            RC(5,0) RC(5,4) RC(5,9)  RC(5,10)                   RC(5,2)  RC(5,3)           RC(5,13) RC(5,5) RC(5,6)
        >;
    };

    kscan0: kscan_0 {
        compatible = "zmk,kscan-gpio-matrix";
        diode-direction = "row2col"; 
        row-gpios =
            <&gpio0 30 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 29 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 19 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 6  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 4  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 3  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
        col-gpios =
            <&gpio0 0  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 1  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, 
            <&gpio0 2  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 7  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 9  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 10 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 15 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 16 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 17 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 18 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 20 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 21 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 22 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 23 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 24 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 25 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 27 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 28 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 31 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            // pines del chip sonix los a√±adi aqui para no causar interferencia
            <&gpio1 2  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 3  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 13 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 11 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
    };

    physical_layout0: physical_layout_0 {
        compatible = "zmk,physical-layout";
        display-name = "HyperX Alloy Rise 75";
        transform = <&default_transform>;
        kscan = <&kscan0>;
        keys =
            /* F0: 15 teclas (Esc hasta Mute) */
            <&key_physical_attrs 100 100 0 0 0 0 0>, <&key_physical_attrs 100 100 125 0 0 0 0>, <&key_physical_attrs 100 100 225 0 0 0 0>, <&key_physical_attrs 100 100 325 0 0 0 0>, <&key_physical_attrs 100 100 425 0 0 0 0>, <&key_physical_attrs 100 100 550 0 0 0 0>, <&key_physical_attrs 100 100 650 0 0 0 0>, <&key_physical_attrs 100 100 750 0 0 0 0>, <&key_physical_attrs 100 100 850 0 0 0 0>, <&key_physical_attrs 100 100 975 0 0 0 0>, <&key_physical_attrs 100 100 1075 0 0 0 0>, <&key_physical_attrs 100 100 1175 0 0 0 0>, <&key_physical_attrs 100 100 1275 0 0 0 0>, <&key_physical_attrs 100 100 1400 0 0 0 0>, <&key_physical_attrs 100 100 1525 0 0 0 0>,

            /* F1: 16 teclas (Grave ... Home, PgUp visualmente abajo) */
            <&key_physical_attrs 100 100 0 125 0 0 0>, <&key_physical_attrs 100 100 100 125 0 0 0>, <&key_physical_attrs 100 100 200 125 0 0 0>, <&key_physical_attrs 100 100 300 125 0 0 0>, <&key_physical_attrs 100 100 400 125 0 0 0>, <&key_physical_attrs 100 100 500 125 0 0 0>, <&key_physical_attrs 100 100 600 125 0 0 0>, <&key_physical_attrs 100 100 700 125 0 0 0>, <&key_physical_attrs 100 100 800 125 0 0 0>, <&key_physical_attrs 100 100 900 125 0 0 0>, <&key_physical_attrs 100 100 1000 125 0 0 0>, <&key_physical_attrs 100 100 1100 125 0 0 0>, <&key_physical_attrs 100 100 1200 125 0 0 0>, 
            <&key_physical_attrs 200 100 1300 125 0 0 0>, /* BkSp */
            <&key_physical_attrs 100 100 1525 125 0 0 0>, /* Home */
            <&key_physical_attrs 100 100 1525 225 0 0 0>, /* PgUp (Movido visualmente a la Fila 2) */

            /* F2: 15 teclas (Tab ... PgDn visualmente abajo) */
            <&key_physical_attrs 150 100 0 225 0 0 0>, <&key_physical_attrs 100 100 150 225 0 0 0>, <&key_physical_attrs 100 100 250 225 0 0 0>, <&key_physical_attrs 100 100 350 225 0 0 0>, <&key_physical_attrs 100 100 450 225 0 0 0>, <&key_physical_attrs 100 100 550 225 0 0 0>, <&key_physical_attrs 100 100 650 225 0 0 0>, <&key_physical_attrs 100 100 750 225 0 0 0>, <&key_physical_attrs 100 100 850 225 0 0 0>, <&key_physical_attrs 100 100 950 225 0 0 0>, <&key_physical_attrs 100 100 1050 225 0 0 0>, <&key_physical_attrs 100 100 1150 225 0 0 0>, <&key_physical_attrs 100 100 1250 225 0 0 0>, 
            <&key_physical_attrs 150 100 1350 225 0 0 0>, /* BSLH */
            <&key_physical_attrs 100 100 1525 325 0 0 0>, /* PgDn (Movido visualmente a la Fila 3) */

            /* F3: 13 teclas (Caps hasta Ret) */
            <&key_physical_attrs 175 100 0 325 0 0 0>, <&key_physical_attrs 100 100 175 325 0 0 0>, <&key_physical_attrs 100 100 275 325 0 0 0>, <&key_physical_attrs 100 100 375 325 0 0 0>, <&key_physical_attrs 100 100 475 325 0 0 0>, <&key_physical_attrs 100 100 575 325 0 0 0>, <&key_physical_attrs 100 100 675 325 0 0 0>, <&key_physical_attrs 100 100 775 325 0 0 0>, <&key_physical_attrs 100 100 875 325 0 0 0>, <&key_physical_attrs 100 100 975 325 0 0 0>, <&key_physical_attrs 100 100 1075 325 0 0 0>, <&key_physical_attrs 100 100 1175 325 0 0 0>, <&key_physical_attrs 225 100 1275 325 0 0 0>,

            /* F4: 13 teclas (LShft hasta Up) */
            <&key_physical_attrs 225 100 0 425 0 0 0>, <&key_physical_attrs 100 100 225 425 0 0 0>, <&key_physical_attrs 100 100 325 425 0 0 0>, <&key_physical_attrs 100 100 425 425 0 0 0>, <&key_physical_attrs 100 100 525 425 0 0 0>, <&key_physical_attrs 100 100 625 425 0 0 0>, <&key_physical_attrs 100 100 725 425 0 0 0>, <&key_physical_attrs 100 100 825 425 0 0 0>, <&key_physical_attrs 100 100 925 425 0 0 0>, <&key_physical_attrs 100 100 1025 425 0 0 0>, <&key_physical_attrs 100 100 1125 425 0 0 0>, <&key_physical_attrs 175 100 1225 425 0 0 0>, <&key_physical_attrs 100 100 1425 425 0 0 0>,

            /* F5: 9 teclas (Ctrl hasta Flechas) */
            <&key_physical_attrs 125 100 0 525 0 0 0>, <&key_physical_attrs 125 100 125 525 0 0 0>, <&key_physical_attrs 125 100 250 525 0 0 0>, <&key_physical_attrs 625 100 375 525 0 0 0>, <&key_physical_attrs 125 100 1000 525 0 0 0>, <&key_physical_attrs 125 100 1125 525 0 0 0>, <&key_physical_attrs 100 100 1325 525 0 0 0>, <&key_physical_attrs 100 100 1425 525 0 0 0>, <&key_physical_attrs 100 100 1525 525 0 0 0>
        ;
    };
};

&sram0 { reg = <0x20000000 DT_SIZE_K(64)>; };
&flash0 {
    partitions {
        compatible = "fixed-partitions";
        #address-cells = <1>; 
        #size-cells = <1>;
        slot0_partition: partition@0 { 
            label = "image-0"; 
            reg = <0x00000000 DT_SIZE_K(224)>; 
        };
        storage_partition: partition@38000 { 
            label = "storage"; 
            reg = <0x00038000 DT_SIZE_K(20)>; 
        };
    };
};
zephyr_udc0: &usbhs {
    status = "okay";
    phy-handle = <&usbphy1>;
};
&usbphy1 { status = "okay"; tx-d-cal = <5>; tx-cal-45-dp-ohms = <10>; tx-cal-45-dm-ohms = <10>; };
