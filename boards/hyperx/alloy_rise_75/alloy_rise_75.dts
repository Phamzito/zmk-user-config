/dts-v1/;
#include <nxp/nxp_lpc55S16_ns.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/gpio/gpio.h>
#include <physical_layouts.dtsi>

/ {
    model = "HyperX Alloy Rise 75";
    compatible = "hyperx,alloy-rise-75", "nxp,lpc55xxx", "nxp,lpc";

    chosen {
        zephyr,sram = &sram0;
        zephyr,flash = &flash0;
        zephyr,code-partition = &slot0_partition;
        zephyr,udc0 = &usbhs;
        zmk,physical-layout = &physical_layout0;
        zmk,kscan = &kscan0;
    };

    aliases { udc0 = &usbhs; };

    left_encoder: encoder_left {
        compatible = "alps,ec11";
        a-gpios = <&gpio1 9 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>; 
        b-gpios = <&gpio1 7 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>; 
        steps = <80>;
        status = "okay";
    };

    sensors: sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&left_encoder>;
        triggers-per-rotation = <20>;
    };

    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <43>;
        rows = <6>;
        map = <
         RC(0,2) RC(0,19) RC(0,28) RC(0,24) RC(0,21) RC(0,1) RC(0,22) RC(0,25) RC(0,3) RC(0,8) RC(0,0) RC(0,18) RC(0,17) RC(0,11) RC(0,27) 
         RC(1,2) RC(1,10) RC(1,19) RC(1,28) RC(1,24) RC(1,21) RC(1,1) RC(1,22) RC(1,25) RC(1,3) RC(1,8) RC(1,0) RC(1,18) RC(1,23) RC(1,16)
         RC(2,2) RC(2,10) RC(2,19) RC(2,28) RC(2,24) RC(2,21) RC(2,1) RC(2,22) RC(2,25) RC(2,3) RC(2,8) RC(2,0) RC(2,18) RC(2,17) RC(1,29)
         RC(3,2) RC(3,10) RC(3,19) RC(3,28) RC(3,24) RC(3,21) RC(3,1) RC(3,22) RC(3,25) RC(3,3) RC(3,8) RC(3,0) RC(3,17) RC(2,16)
         RC(4,2) RC(4,19) RC(4,28) RC(4,24) RC(4,21) RC(4,1) RC(4,22) RC(4,25) RC(4,3) RC(4,8) RC(4,0) RC(4,17) RC(4,11)
         RC(5,2) RC(5,10) RC(5,19) RC(5,21) RC(5,3) RC(5,8) RC(5,23) RC(5,11) RC(5,16)
        >;
    };

    kscan0: kscan_0 {
        compatible = "zmk,kscan-gpio-matrix";
        wakeup-source;
        diode-direction = "row2col";
        row-gpios =
            <&gpio0 30 GPIO_ACTIVE_HIGH>, <&gpio0 29 GPIO_ACTIVE_HIGH>, <&gpio0 19 GPIO_ACTIVE_HIGH>,
            <&gpio0 6  GPIO_ACTIVE_HIGH>, <&gpio0 4  GPIO_ACTIVE_HIGH>, <&gpio0 3  GPIO_ACTIVE_HIGH>;
        col-gpios =
            <&gpio0 1  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 21 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 0  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 2  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 3  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 4  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 5  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 6  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 7  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 8  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 9  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 10 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 11 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 12 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 13 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 14 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 15 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 16 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 17 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 18 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 19 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 20 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 22 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 23 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 24 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 25 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 26 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 27 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio0 28 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio0 31 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 0  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 1  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 2  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 3  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 4  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 6  (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 10 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 11 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 12 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 13 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 14 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 15 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 16 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>, <&gpio1 17 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>,
            <&gpio1 21 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
    };
    
    physical_layout0: physical_layout_0 {
        compatible = "zmk,physical-layout";
        display-name = "HyperX 75%";
        transform = <&default_transform>;
        kscan = <&kscan0>;
        keys = 
            /* FILA 0 */
            <&key_physical_attrs 100 100 0 0 0 0 0>, 
            <&key_physical_attrs 100 100 125 0 0 0 0>, <&key_physical_attrs 100 100 225 0 0 0 0>, <&key_physical_attrs 100 100 325 0 0 0 0>, <&key_physical_attrs 100 100 425 0 0 0 0>,
            <&key_physical_attrs 100 100 550 0 0 0 0>, <&key_physical_attrs 100 100 650 0 0 0 0>, <&key_physical_attrs 100 100 750 0 0 0 0>, <&key_physical_attrs 100 100 850 0 0 0 0>,
            <&key_physical_attrs 100 100 975 0 0 0 0>, <&key_physical_attrs 100 100 1075 0 0 0 0>, <&key_physical_attrs 100 100 1175 0 0 0 0>, <&key_physical_attrs 100 100 1275 0 0 0 0>,
            <&key_physical_attrs 100 100 1400 0 0 0 0>, <&key_physical_attrs 100 100 1525 0 0 0 0>,

            /* FILA 1 */
            <&key_physical_attrs 100 100 0 125 0 0 0>, <&key_physical_attrs 100 100 100 125 0 0 0>, <&key_physical_attrs 100 100 200 125 0 0 0>, <&key_physical_attrs 100 100 300 125 0 0 0>, <&key_physical_attrs 100 100 400 125 0 0 0>, <&key_physical_attrs 100 100 500 125 0 0 0>, <&key_physical_attrs 100 100 600 125 0 0 0>, <&key_physical_attrs 100 100 700 125 0 0 0>, <&key_physical_attrs 100 100 800 125 0 0 0>, <&key_physical_attrs 100 100 900 125 0 0 0>, <&key_physical_attrs 100 100 1000 125 0 0 0>, <&key_physical_attrs 100 100 1100 125 0 0 0>, <&key_physical_attrs 100 100 1200 125 0 0 0>, 
            <&key_physical_attrs 200 100 1300 125 0 0 0>, 
            <&key_physical_attrs 100 100 1525 125 0 0 0>, 

            /* FILA 2 */
            <&key_physical_attrs 150 100 0 225 0 0 0>, <&key_physical_attrs 100 100 150 225 0 0 0>, <&key_physical_attrs 100 100 250 225 0 0 0>, <&key_physical_attrs 100 100 350 225 0 0 0>, <&key_physical_attrs 100 100 450 225 0 0 0>, <&key_physical_attrs 100 100 550 225 0 0 0>, <&key_physical_attrs 100 100 650 225 0 0 0>, <&key_physical_attrs 100 100 750 225 0 0 0>, <&key_physical_attrs 100 100 850 225 0 0 0>, <&key_physical_attrs 100 100 950 225 0 0 0>, <&key_physical_attrs 100 100 1050 225 0 0 0>, <&key_physical_attrs 100 100 1150 225 0 0 0>, <&key_physical_attrs 100 100 1250 225 0 0 0>,
            <&key_physical_attrs 150 100 1350 225 0 0 0>, 
            <&key_physical_attrs 100 100 1525 225 0 0 0>, 

            /* FILA 3 */
            <&key_physical_attrs 175 100 0 325 0 0 0>, <&key_physical_attrs 100 100 175 325 0 0 0>, <&key_physical_attrs 100 100 275 325 0 0 0>, <&key_physical_attrs 100 100 375 325 0 0 0>, <&key_physical_attrs 100 100 475 325 0 0 0>, <&key_physical_attrs 100 100 575 325 0 0 0>, <&key_physical_attrs 100 100 675 325 0 0 0>, <&key_physical_attrs 100 100 775 325 0 0 0>, <&key_physical_attrs 100 100 875 325 0 0 0>, <&key_physical_attrs 100 100 975 325 0 0 0>, <&key_physical_attrs 100 100 1075 325 0 0 0>, <&key_physical_attrs 100 100 1175 325 0 0 0>,
            <&key_physical_attrs 225 100 1275 325 0 0 0>, 
            <&key_physical_attrs 100 100 1525 325 0 0 0>, 

            /* FILA 4 */
            <&key_physical_attrs 225 100 0 425 0 0 0>, <&key_physical_attrs 100 100 225 425 0 0 0>, <&key_physical_attrs 100 100 325 425 0 0 0>, <&key_physical_attrs 100 100 425 425 0 0 0>, <&key_physical_attrs 100 100 525 425 0 0 0>, <&key_physical_attrs 100 100 625 425 0 0 0>, <&key_physical_attrs 100 100 725 425 0 0 0>, <&key_physical_attrs 100 100 825 425 0 0 0>, <&key_physical_attrs 100 100 925 425 0 0 0>, <&key_physical_attrs 100 100 1025 425 0 0 0>, <&key_physical_attrs 100 100 1125 425 0 0 0>,
            <&key_physical_attrs 175 100 1225 425 0 0 0>, 
            <&key_physical_attrs 100 100 1425 425 0 0 0>, 

            /* FILA 5 */
            <&key_physical_attrs 125 100 0 525 0 0 0>, <&key_physical_attrs 125 100 125 525 0 0 0>, <&key_physical_attrs 125 100 250 525 0 0 0>, 
            <&key_physical_attrs 625 100 375 525 0 0 0>, 
            <&key_physical_attrs 125 100 1000 525 0 0 0>, <&key_physical_attrs 125 100 1125 525 0 0 0>,
            <&key_physical_attrs 100 100 1325 525 0 0 0>, <&key_physical_attrs 100 100 1425 525 0 0 0>, <&key_physical_attrs 100 100 1525 525 0 0 0>
        ;
    };
};

/* --- PARTICIONES --- */
&sram0 { reg = <0x20000000 DT_SIZE_K(64)>; };
&flash0 {
    partitions {
        compatible = "fixed-partitions";
        #address-cells = <1>; #size-cells = <1>;
        boot_partition: partition@0 { label = "mcuboot"; reg = <0x0 DT_SIZE_K(32)>; };
        slot0_partition: partition@8000 { label = "image-0"; reg = <0x00008000 DT_SIZE_K(192)>; };
        storage_partition: partition@38000 { label = "storage"; reg = <0x00038000 DT_SIZE_K(20)>; };
    };
};

zephyr_udc0: &usbhs {
    pinctrl-0 = <&swd_pins_free>;
    pinctrl-names = "default";
    status = "okay";
    phy-handle = <&usbphy1>;
};

&pinctrl {
    swd_pins_free: swd_pins_free {
        group0 { pinmux = <0x00000B50>, <0x00000C50>; };
    };
};

&usbphy1 { status = "okay"; tx-d-cal = <5>; tx-cal-45-dp-ohms = <10>; tx-cal-45-dm-ohms = <10>; };
&flexcomm0 { status = "disabled"; };
&flexcomm4 { status = "disabled"; };